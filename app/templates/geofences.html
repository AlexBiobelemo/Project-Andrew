{% extends "base.html" %}

{% block content %}
<div class="container form-page-container">
    <h1>My Geofences</h1>
    <p>Create geographic areas to receive notifications when issues are reported within them.</p>

    <div class="row">
        <div class="col-md-8">
            <div id="geofence-map" style="height: 500px; border: 1px solid #ccc;"></div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Create New Geofence</h5>
                </div>
                <div class="card-body">
                    <form id="geofence-form">
                        <div class="mb-3">
                            <label for="geofence-name" class="form-label">Geofence Name</label>
                            <input type="text" class="form-control" id="geofence-name" required>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notify-checkbox" checked>
                                <label class="form-check-label" for="notify-checkbox">
                                    Notify me when issues are reported in this area
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="save-geofence-btn">Save Geofence</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <h3>Existing Geofences</h3>
            <div id="geofences-list">
                {% for geofence in geofences %}
                <div class="card mb-2">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">{{ geofence.name }}</h6>
                            <small class="text-muted">
                                Notifications: {% if geofence.notify_on_issue %}Enabled{% else %}Disabled{% endif %}
                            </small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger delete-geofence" data-id="{{ geofence.id }}">
                            Delete
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    // Geofence Map Configuration
    const geofenceMap = L.map('geofence-map').setView([4.9248, 6.2647], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(geofenceMap);

    const drawnItems = new L.FeatureGroup();
    geofenceMap.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
        edit: { featureGroup: drawnItems },
        draw: { polygon: true, polyline: false, rectangle: false, circle: false, marker: false }
    });
    geofenceMap.addControl(drawControl);

    let currentGeofence = null;

    geofenceMap.on(L.Draw.Event.CREATED, ({ layer }) => {
        drawnItems.clearLayers();
        drawnItems.addLayer(layer);
        currentGeofence = layer.toGeoJSON().geometry;
    });

    // Load existing geofences
    {% for geofence in geofences %}
    L.geoJSON({{ geofence.geometry | tojson }}).addTo(geofenceMap);
    {% endfor %}

    // Form submission
    document.getElementById('geofence-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('geofence-name').value;
        const notify = document.getElementById('notify-checkbox').checked;

        if (!currentGeofence) {
            alert('Please draw a geofence on the map first.');
            return;
        }

        try {
            const response = await fetch('/geofences', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    geometry: currentGeofence,
                    notify_on_issue: notify
                })
            });

            if (response.ok) {
                alert('Geofence saved successfully!');
                location.reload();
            } else {
                alert('Failed to save geofence.');
            }
        } catch (error) {
            console.error('Error saving geofence:', error);
            alert('An error occurred while saving the geofence.');
        }
    });

    // Delete geofence
    document.querySelectorAll('.delete-geofence').forEach(button => {
        button.addEventListener('click', async () => {
            if (!confirm('Are you sure you want to delete this geofence?')) return;

            const geofenceId = button.dataset.id;
            try {
                const response = await fetch(`/geofence/${geofenceId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    button.closest('.card').remove();
                } else {
                    alert('Failed to delete geofence.');
                }
            } catch (error) {
                console.error('Error deleting geofence:', error);
                alert('An error occurred while deleting the geofence.');
            }
        });
    });
</script>
{% endblock %}